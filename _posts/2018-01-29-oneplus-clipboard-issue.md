---
layout: post
title:  "一加手机最新beta系统中剪切板程序简要分析"
date:   2018-01-29
---



# 缘由

以前总听人们说一加手机是黑客手机、刷机小王子，于是去年买了个一加3T。自去年十月以来，一加已经被爆出太多的丑闻，前两天推特上更是看到最新氧系统beta版的剪切板有匹配字符串的功能，而且会把用户的一些信息上传到大陆某家公司的网站，为了深刻认识官方系统的安全性，我打算也慢慢学着分析一下。由于对Java不太熟练，我把我看到的一点点东西贴出来，有兴趣的朋友可以研究一下。

![](https://bbs.pediy.com/upload/attach/201801/579848_AQVCCMWWGCMDJQN.png)


## 下载一加氢系统

我猜测国内和国外的系统内置应用大概不一样，到[这里](http://www.h2os.com/download)找到你感兴趣的下载链接，我用的是[一加3T公测版Android 8.0第6版](http://download.h2os.com/OnePlus%203T/OPEN/OnePlus3THydrogen_28_OTA_042_all_1801181105_27ae1c3d35234b93.zip)。

## 提取ROM中的应用

首先解压下载好的ROM包，进入解压后的目录，可以看到下面的文件：

```
boot.img(内核) 
firmware-update/
META-INF/
RADIO/
system.new.dat(压缩后的系统分区) 
system.patch.dat(用于OTA)
system.transfer.list
```

下载[sdat2img.py](https://github.com/xpirt/sdat2img/blob/master/sdat2img.py)，sdat2img.py的一点说明：

`sdat2img.py <transfer_list> <system_new_file> <system_ext4>`

    - <transfer_list> = input, system.transfer.list from rom zip 
    - <system_new_file> = input, system.new.dat from rom zip 
    - <system_ext4> = output ext4 raw image file

在此处，我们执行`sdat2img.py system.transfer.list system.new.dat system.img`，之后执行`file system.img`，可以得到类似的信>息：


```
system.img:           Linux rev 1.0 ext4 filesystem data, UUID=da594c53-9beb-f85c-85c5-cedf76546f7a, volume name "system" (extents) (large files)
```
使用`mount`命令把这个文件当成一个硬盘分区，挂载到某个目录下就行了。比如：

```sh
mkdir tmp 
sudo mount -t ext4 system.img tmp/
```

然后执行`find . | grep -i clipboard`找到相关的应用所在的位置：

```
./app/OPClipBoardManager/OPClipBoardManager.apk
```

计算校验值后发现和氧系统的校验值是相同的。
 ![校验值](https://bbs.pediy.com/upload/attach/201801/579848_K7CZJY9QWXFFWZH.png)

之后可以把应用复制到工作目录，用`apktool`、`Android Studio`分析smali代码，或者用`dex2jar`把解压后的`classes.dex`转换成`jar`文件，用`Java Decompiler`查看Java代码。

`apktool`反编译后的文件夹中，`./assets`目录下有一些有趣的文件:

```
address_ac.model
airport_short_name.model
badword.txt
BaiduNaviSDK_Resource_v1_0_0.png
BBB_test.txt
bubble_sms.in
channel
city_ac.model
config.ini
dic.dat
html/
jcseg.properties
mapping.txt
md5.txt
obscure_word_ac.model
obscure_word_explanation.dic
parser.dic
parser.zip
pattern.zip
province_ac.model
sharesmap.txt
shares.model
sms_address_parser.conf
sms_bubble_stable_ac.index
sms_bubble_stable_others.index
sms_bubble_stable_regex.db
sms_card_stable_ac.index
sms_card_stable_others.index
sms_card_stable_regex.db
sms.cfg
sms_standard_parser.conf
startword.txt
version_recorder.txt
w.dat
```

剪切板应用可能会匹配其中的一些字符串，也可能会收集用户的信息。下面是`BBB_test.txt`文件：

```
山东省临沂市沂南县工业园舜合胶业有限公司。收货电话18669622466
https://www.baidu.com
【星美电影】您订购的星美国际影城-拉萨神力店VIP厅 11月22日18时45分《荒野猎人》  3排1号，取票序列号 112488 验证码 818975， 请您到星美自助终端机或影城前台取票，并对号入座，客服微信：xm_smi，祝您观影愉快！
[东方航空]您成功取消了于2016年02月26日15:20起飞的MU2310的网上值机服务,欢迎您下次使用东航网上值机服务.
已成功为您购得11月24日北京到上海G105次车票.取票流水号:E623285695 座位号:02车厢 086号 .请尽快前往火车站或代售点换取纸质车票.祝旅途愉快!【火车票TM】
袁隆平宣布重大成果：水稻亲本去镉技术获突破。
最后定下research questions，理论框架，研究方法。
尊敬的客户，您的手机号码18398731615在2015年11月05日12时46分成功缴费20.0元，您当前话费余额为14.33元。拨打10086按2再按1键，话费充值安全方便又快捷。
这个麤慥你认识么
【锐赢运动户外专营店】启奏tb为你停留陛下，您的宝贝发出，不日将达。（顺丰快递：278108099656）
截止2015年01月29日11:20，您的余额为29.53元；欢迎使用联通网上营业厅www.10010.com查询、充值及办理多种业务！
我特别喜欢看现在进行时这本书
我觉得迪丽热巴真美啊
```

这个是`badword.txt`文件：

```
(?:些)|(?:凭)|(?:限)|(?:挫)|(?:差)|(?:凶)|(?:恶)|(?:死)|(?:臭)|(?:烂)|(?:矮)|(?:催)|(?:的)|(?:抬)|(?:订)|(?:追)|(?:给)|(?:赶)|(?:死)|(?:穷)|(?:搬)|(?:把)|(?:用)|(?:拍)|(?:比)|(?:找)|(?:按)|(?:有)|(?:受)|(?:个)|(?:打)|(?:拨)|(?:喊)|(?:骂)|(?:叫)|(?:坐)|(?:或)|(?:送)|(?:就)|(?:在)|(?:提)|(?:取)|(?:拿)|(?:次)|(?:位)|(?:落)|(?:于)|(?:肝)|(?:胆)|(?:脾)|(?:肺)|(?:肾)|(?:脏)|(?:腑)|(?:啊)|(?:列表)|(?:官网)|(?:主页)|(?:官方)|(?:资料)|(?:感觉)|(?:感到)|(?:作为)|(?:修饰)|(?:结果)|(?:原因)|(?:问题)|(?:左手)|(?:右手)|(?:内地)|(?:外地)|(?:故障)|(?:一般)|(?:一半)|(?:不要)|(?:鼻子)|(?:眼睛)|(?:耳朵)|(?:嘴巴)|(?:方法)|(?:首歌)|(?:几天)|(?:办法)|(?:你(?!这|那))|(?:我(?!这|那))|(?:他(?!这|那))|(?:您(?!这|那))|(?:俺(?!这|那))|(?:[一二三四五六七八九]流)|(?:[重轻快慢]点)|(?:纪念版)|(?:老版)|(?:原版)|(?:新版)|(?:企业)|(?:礼拜)|(?:物联)|(?:互联)|(?:工作)|(?:恒温)|(?:恒湿)|(?:房间)|(?:浓度)|(?:准备)|(?:晦气)|(?:高楼)|(?:app)|(?:APP)|(?:beta)|(?:Beta)|(?:vs)|(?:VS)|(?::)|(?:全[球国省市县区乡镇村部])|(?:相册)|(?:应用)|(?:截图)|(?:视屏)|(?:左右)|(?:前后)|(?:对象)|(?:掌上)|(?:信息)|(?:跟前)|(?:电视)|(?:介绍)|(?:档案)|(?:简历)|(?:病历)|(?:外快)|(?:资历)|(?:骗子)|(?:任职)|(?:困难)|(?:移交)|(?:直接)|(?:生日)|(?:庆生)|(?:手机)|(?:融资)|(?:项目)|(?:部门)|(?:生意)|(?:电脑)|(?:鞋子)|(?:袜子)|(?:裙子)|(?:衣服)|(?:裤子)|(?:纪念日)|(?:按照)|(?:领袖)|(?:品牌)|(?:邮件)|(?:短信)|(?:消息)|(?:私信)|(?:微信)|(?:QQ)|(?:qq)|(?:微博)|(?:状态)|(?:私人)|(?:老大)|(?:老板)|(?:兄弟)|(?:组织)|(?:协议)|(?:要道)|(?:应该)|(?:时候)|(?:习惯)|(?:之前)|(?:之后)|(?:积分)|(?:上家)|(?:下家)|(?:小伙)|(?:大妈)|(?:部分)|(?:更新)|(?:邮箱)|(?:哪家)|(?:时间)|(?:电子)|(?:哪个)|(?:哪里)|(?:大雪)|(?:声明)|(?:官微)|(?:客户)|(?:不是)|(?:地点)|(?:地址)|(?:物流)|(?:天价)|(?:甲方)|(?:乙方)|(?:丙方)|(?:收入)|(?:支出)|(?:流水)|(?:账单)|(?:家庭)|(?:收支)|(?:地铁)|(?:上铺)|(?:下铺)|(?:航班)|(?:钢管)|(?:地垫)|(?:垫子)|(?:管道)|(?:管子)|(?:会员)|(?:职员)|(?:员工)|(?:教工)|(?:职工)|(?:电话)|(?:星期)|(?:同学)|(?:丈母娘)|(?:领导)|(?:她家)|(?:科室)|(?:[\u4e00-\u9fa5]{1,2}卡)|(?:[\u4e00-\u9fa5]老)|(?:[\u4e00-\u9fa5]总)|(?:[\u4e00-\u9fa5]员)|(?:[大小]城市)|(?:县长)|(?:村长)|(?:我儿)|(?:书记)|(?:镇长)|(?:[大小]?师[兄哥姐妹弟])|(?:小叔)|(?:小姑)|(?:[大二三四五]?(?:儿子|女儿))|(?:父母)|(?:爸妈)|(?:曾?祖[父母])|(?:伯[父母])|(?:姑[母姑父])|(?:堂[伯叔哥姐弟妹])|(?:表[哥姐弟妹])|(?:嫂[嫂子]?)|(?:[大小]?侄[子女])|(?:外甥女?)|(?:女婿)|(?:外祖[父母])|(?:舅[舅父母妈])|(?:姨[母妈父])|(?:岳[父母])|(?:老?丈人)|(?:[大伯]伯)|(?:[大小]姑子)|(?:奶奶)|(?:爷爷)|(?:姥姥)|(?:外[公婆])|(?:老?爸爸?)|(?:老?妈妈?)|(?:[父母]亲)|(?:老[公婆])|(?:叔叔?)|(?:阿?姨)|(?:大[爷妈婶哥姐])|(?:[大小]舅子)|(?:婶[婶儿]?)|(?:哥哥?)|(?:姐姐?)|(?:妹[子妹]?)|(?:弟弟?)|(?:[男女]?朋友)|(?:[男女][生人])|(?:董事长)|(?:副?院长)|(?:副?总监)|(?:副?总?经理)|(?:主任)|(?:副?[部厅所处会班连团军旅]长)|(?:副?科[长员])|(?:副?教授)|(?:副?校长)|(?:秘书)|(?:老师)|(?:师傅)|(?:医生)|(?:辅导员)|(?:老板娘?)|(?:[大中上][校尉将])|(?:将军)|(?:孩子)|(?:家长)|(?:博士)|(?:教授)|(?:学生)|(?:助教)|(?:记得)|(?:网上)|(?:[高中低][档端])|(?:逼格)|(?:档次)|(?:创业)|(?:同事)|(?:计算机)|(?:[大中上]型)|(?:下载)|(?:安装)|(?:卸载)|(?:搜索)|(?:更换)|(?:首届)|(?:明天)|(?:今天)|(?:又称)|(?:代表)|(?:买)|(?:现房)|(?:堵车)|(?:微信)|(?:加入)|(?:领取)|(?:首座)|(?:精装)|(?:使我)|(?:参加)|(?:造成)|(?:有些)|(?:整合)|(?:局部)|(?:可能)|(?:出现)|(?:运费)|(?:医保)|(?:左右)|(?:新建)|(?:播出)|(?:请家长)|(?:摇号)|(?:我们)|(?:4[Gg])
```

用`JD-GUI`查看生成的`jar`文件，可以发现专门匹配银行卡帐号的代码段：

 ![匹配银行卡](https://bbs.pediy.com/upload/attach/201801/579848_N4E9NPN5SHEP3AA.png)


# 最后

![](https://bbs.pediy.com/upload/attach/201801/579848_VY9WRYWCGZ87JAR.png)

有兴趣的朋友可以到[Koodous]下载整个应用研究。大部分用户并没有受到影响，这应该是最新beta版系统添加的应用，使用稳定版的朋友不用担心，但我还是建议大家刷机吧，一加太让人失望了！这款应用主要针对的是大陆用户，国外的黑客可能不会继续深入研究。

下载地址(需要帐号)：
```
https://koodous.com/apks/2f8a01035e0409d1a44c5d658bac0ba4e900df6f017556ce07b33a6c5c9ffa99
```
